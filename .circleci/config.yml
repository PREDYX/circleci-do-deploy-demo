version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - add_ssh_keys:
          fingerprints:
            - "SHA256:WwBKHD8LpFo2M0MTyTd99kpjhdJegXHYQofLCYPrjnY"

      - run:
          name: Build & Deploy on Droplet
          command: |
            ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST"
              set -e

              echo "üì¶ Pulling repo or updating"
              if [ ! -d ~/circleci-do-deploy-demo ]; then
                git clone https://github.com/YOUR_ORG/circleci-do-deploy-demo.git
              fi

              cd ~/circleci-do-deploy-demo
              git pull

              echo "üê≥ Building Docker image"
              docker build -t circleci-do-deploy-demo:latest .

              echo "üßπ Removing old container"
              docker rm -f circleci-do-deploy-demo || true

              echo "üöÄ Starting container"
              docker run -d \
                --name circleci-do-deploy-demo \
                -p 3000:3000 \
                -e APP_VERSION=${CIRCLE_SHA1} \
                -e ENVIRONMENT=test \
                circleci-do-deploy-demo:latest

              echo "‚úÖ Deployment complete"
            EOF

workflows:
  deploy:
    jobs:
      - deploy
